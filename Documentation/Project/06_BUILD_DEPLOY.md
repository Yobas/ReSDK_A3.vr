# Сборка и деплой

Проект использует RBuilder для сборки SQF кода и развертывания проекта. **Важно:** Проект собирается автоматически сервисом обновления, который отслеживает коммиты и релизы в репозитории.

## Автоматическая сборка сервисом обновления

Проект собирается **сервисом обновления** - внешним Python-скриптом, работающим на сервере. Сервис автоматически отслеживает коммиты и релизы в репозитории GitHub через GitHub API и выполняет сборку и деплой без участия разработчиков.

**Как работает сервис обновления:**

1. **Отслеживание изменений:** Сервис периодически проверяет репозиторий через GitHub API на наличие новых коммитов в ветке `main` и новых релизов
2. **Скачивание кода:** При обнаружении изменений сервис скачивает архив репозитория
3. **Подготовка к сборке:**
   - Обновляет файлы `VERSION` и `REVISION` (для релизов - из тега, для dev - из последнего коммита)
   - Копирует `private.h` из защищенного хранилища на сервере
   - Обновляет `CHANGELOGS.txt` (для релизов)
4. **Сборка:**
   - Запускает ReNode для подготовки графов визуального программирования
   - Запускает RBuilder для сборки проекта
5. **Деплой:** Развертывает собранную версию на серверах
6. **Уведомления:** Отправляет уведомления в Discord о процессе сборки и результатах

**Важно для разработчиков:**
- Сервис работает полностью автоматически и не требует действий от разработчиков
- Автоматическая сборка происходит при мерже в ветку `main` и при выпуске нового релиза
- Dev-версии не собираются сервисом на сервере (используются только для локальной разработки)

### Dev-версии (локальная разработка)

**Dev-версии используются для локальных экспериментов** и разработки новых функций (например, экспериментальных функций редактора), которые позже попадут в `main`. Они **не собираются сервисом обновления на сервере**.

Для локальной сборки dev-версий:
- Разработчики собирают их вручную с помощью RBuilder
- `private.h` не требуется (если не используется шифрование)
- `REVISION` обычно содержит `Unrevisioned` при локальной разработке

**Примечание:** Сервис обновления собирает только релизные версии. Подробнее о `private.h` см. [Версионирование](07_VERSIONING.md#файл-privateh).

### Релизные версии (автоматическая сборка на сервере)

При публикации релиза на GitHub сервис обновления автоматически:
- Обнаруживает новый релиз
- Обновляет `VERSION` с версией из тега
- Обновляет `REVISION` с SHA коммита
- Обновляет `CHANGELOGS.txt`
- Копирует `private.h` из внешнего источника конфигурации
- Собирает релизную версию через RBuilder
- Развертывает на серверах

**Для разработчиков:** Обычно сборку выполняет сервис обновления. Ручная сборка нужна только для локальной разработки и тестирования.

## RBuilder - система сборки SQF

RBuilder - это утилита для препроцессинга и упаковки SQF кода в форматы, необходимые для Платформы.

### Конфигурация

Конфигурация находится в `RBuilder/config.yml`:

```yaml
version: 1

# Пути проекта
pathes:
  sources: ../Src
  deploy_dir: ./deploy

# Определения для компиляции
defines:
  RELEASE:
  DEBUG:
  
# Настройки сборки
build:
  include: Inventory\inventory.hpp;LightEngine\LightEngine.hpp
  exclude: Editor;Scripts;.vscode
```

### Процесс сборки

#### Сборка клиентского кода

Клиентский код собирается в специальный формат для передачи клиенту:

1. RBuilder читает `client/loader.hpp`
2. Компилирует все модули, зарегистрированные через `importClient()`
3. Создает массив `allClientContents` с функциями инициализации
4. Сохраняет результат в файл `CLIENT` для загрузки клиентами

**Важно:** Порядок модулей в `loader.hpp` критичен для правильной загрузки.

#### Сборка серверного кода

Серверный код собирается в PBO файлы для развертывания на сервере:

1. RBuilder обрабатывает `host/init.sqf`
2. Компилирует все модули, загружаемые через `loadFile()`
3. Упаковывает код в PBO формат
4. Генерирует необходимые файлы конфигурации

### Режимы сборки

#### DEBUG режим

```bash
# Сборка в режиме отладки
rb build -debug
```

**Особенности:**
- Включены все отладочные функции
- Подробное логирование
- Проверки и assertions активны

#### RELEASE режим

```bash
# Сборка релизной версии
rb build -release
```

**Особенности:**
- Отключены отладочные функции
- Оптимизации включены
- Минимальное логирование

### Деплой через RBuilder

#### Деплой редактора

```bash
# Деплой мода редактора
rb deploy -editor ARMA3_DIR

# Или используйте DEPLOY.bat в папке RBuilder
DEPLOY.bat
```

**Что делает:**
- Копирует файлы из `RBuilder/deploy/editor/` в `@EditorContent`
- Подготавливает необходимые DLL и ресурсы
- Создает структуру мода для Arma 3

**Где:** `Arma3/@EditorContent/`

#### Деплой клиентских модулей

Клиентские модули автоматически включаются в файл миссии при сборке.

#### Деплой серверных модулей

Серверные модули упаковываются в PBO и размещаются на сервере.

### Конфигурация путей

RBuilder использует пути из `config.yml`:

```yaml
pathes:
  sources: ../Src              # Исходный код
  deploy_dir: ./deploy         # Директория деплоя
  bin_dir: ./bin              # Временные файлы сборки
```

### Включение/исключение файлов

В `config.yml` можно настроить, какие файлы включать/исключать:

```yaml
build:
  include: Inventory\inventory.hpp;LightEngine\LightEngine.hpp
  exclude: Editor;Scripts;.vscode
```

## RVEngine (минимальная информация)

**Важно:** RVEngine - это внешний компонент с собственной документацией и системой сборки.

### Основная информация

- RVEngine - это C++ расширение для Arma 3
- Имеет собственную систему сборки на основе CMake
- Документация находится в `Documentation/RVEngine/`
- Разработчики проекта не поддерживают RVEngine напрямую

### Для работы с RVEngine

См. документацию в `Documentation/RVEngine/BUILD_GUIDE.md` и `Documentation/RVEngine/README.md`.

## Деплой

### Структура деплоя

```
Arma3/
├── @EditorContent/          # Мод редактора
│   ├── *.dll               # Библиотеки редактора
│   └── ...
└── missions/
    └── ReSDK_A3.vr/        # Миссия с кодом
        ├── CLIENT          # Клиентский код
        ├── *.pbo           # Серверные модули
        └── ...
```

### Деплой редактора

1. Запустите `RBuilder/DEPLOY.bat` или `rb deploy -editor`
2. Укажите путь к Arma 3, если запрошено
3. Подключите мод `@EditorContent` в лаунчере Arma 3
4. Запустите Arma 3 с выключенным BattlEye

**Важно:** Первый раз RBuilder запросит путь к Arma 3 и сохранит его в `platform_path.cache`.

### Деплой на сервер

1. Соберите проект в режиме RELEASE
2. Скопируйте PBO файлы на сервер
3. Разместите их в соответствующей директории сервера
4. Перезапустите сервер

### Проверка корректности деплоя

#### Проверка редактора

1. Запустите Arma 3 с модом `@EditorContent`
2. Откройте редактор
3. Загрузите миссию `ReSDK_A3.vr`
4. Проверьте логи на ошибки загрузки

#### Проверка клиентской сборки

1. Проверьте наличие файла `CLIENT` в миссии
2. Подключитесь к серверу
3. Проверьте логи клиента на ошибки загрузки

#### Проверка серверной сборки

1. Проверьте наличие всех необходимых PBO файлов
2. Запустите сервер
3. Проверьте логи сервера на ошибки загрузки

## Типичные проблемы

### Ошибки компиляции

**Проблема:** Ошибки при сборке модулей

**Решение:**
- Проверьте синтаксис кода
- Убедитесь, что все зависимости загружены
- Проверьте логи RBuilder на детали ошибок

### Отсутствующие файлы при деплое

**Проблема:** Файлы не копируются в `@EditorContent`

**Решение:**
- Проверьте пути в `config.yml`
- Убедитесь, что файлы существуют в `deploy/editor/`
- Проверьте права доступа к файлам

### Версии не совпадают

**Проблема:** Клиент и сервер имеют разные версии

**Решение:**
- Убедитесь, что файл `VERSION` одинаковый
- Пересоберите проект
- Очистите кэш сборки

## Что дальше?

- ➡️ [Версионирование](07_VERSIONING.md) - управление версиями при сборке
- ➡️ [Отладка](05_DEBUGGING.md) - отладка собранного проекта
- ➡️ [Решение проблем](10_TROUBLESHOOTING.md) - дополнительные решения проблем

