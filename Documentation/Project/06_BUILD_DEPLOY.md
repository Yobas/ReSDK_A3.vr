# Сборка и деплой

Проект использует RBuilder для сборки SQF кода и развертывания проекта. **Важно:** Проект собирается автоматически сервисом обновления, который отслеживает коммиты и релизы в репозитории.

## Автоматическая сборка сервисом обновления

Проект собирается **сервисом обновления**. Подробнее о сервисе обновления см. [Версионирование](07_VERSIONING.md#автоматическая-сборка-сервисом-обновления).

**Как работает сервис обновления:**

1. **Отслеживание изменений:** Сервис периодически проверяет репозиторий через GitHub API на наличие новых коммитов в ветке `main` и новых релизов
2. **Скачивание кода:** При обнаружении изменений сервис скачивает архив репозитория
3. **Подготовка к сборке:**
   - Обновляет файлы `VERSION` и `REVISION` (для релизов - из тега, для dev - из последнего коммита)
   - Копирует `private.h` из защищенного хранилища на сервере
   - Обновляет `CHANGELOGS.txt` (для релизов)
4. **Сборка:**
   - Запускает ReNode для подготовки графов визуального программирования
   - Запускает RBuilder для сборки проекта
5. **Деплой:** Развертывает собранную версию на серверах
6. **Уведомления:** Отправляет уведомления в Discord о процессе сборки и результатах

**Важно для разработчиков:**
- Сервис работает полностью автоматически и не требует действий от разработчиков
- Автоматическая сборка происходит при мерже в ветку `main` и при выпуске нового релиза
- Dev-версии не собираются сервисом на сервере (используются только для локальной разработки)

### Dev-версии (локальная разработка)

**Dev-версии используются для локальных экспериментов** и разработки новых функций (например, экспериментальных функций редактора), которые позже попадут в `main`. Они **не собираются сервисом обновления на сервере**.

Для локальной сборки dev-версий:
- Разработчики собирают их вручную с помощью RBuilder
- `private.h` не требуется (если не используется шифрование)
- `REVISION` обычно содержит `Unrevisioned` при локальной разработке

**Примечание:** Сервис обновления собирает только релизные версии. Подробнее о `private.h` см. [Версионирование](07_VERSIONING.md#файл-privateh).

### Релизные версии (автоматическая сборка на сервере)

При публикации релиза на GitHub сервис обновления автоматически:
- Обнаруживает новый релиз
- Обновляет `VERSION` с версией из тега
- Обновляет `REVISION` с SHA коммита
- Обновляет `CHANGELOGS.txt`
- Копирует `private.h` из внешнего источника конфигурации
- Собирает релизную версию через RBuilder
- Развертывает на серверах

**Для разработчиков:** Обычно сборку выполняет сервис обновления. Ручная сборка нужна только для локальной разработки и тестирования.
Для ручной сборки можно воспользоваться заданием "BUILD PROJECT" в VS Code.

## RBuilder - система сборки SQF

RBuilder - это утилита для препроцессинга и упаковки SQF кода в форматы, необходимые для Платформы.

### Конфигурация

Конфигурация находится в `RBuilder/config.yml`:

```yaml
version: 1

# Пути проекта
pathes:
  sources: ../Src
  deploy_dir: ./deploy

# Определения для компиляции
defines:
  RELEASE:
  DEBUG:
  
# Настройки сборки
build:
  include: Inventory\inventory.hpp;LightEngine\LightEngine.hpp
  exclude: Editor;Scripts;.vscode
```

### Процесс сборки

#### Сборка клиентского кода

Клиентский код собирается в специальный формат для передачи клиенту:

1. RBuilder читает `client/loader.hpp`
2. Компилирует все модули, зарегистрированные через `importClient()`
3. Создает массив `allClientContents` с функциями инициализации
4. Сохраняет результат в файл `CLIENT` (без расширения) для загрузки клиентами
5. Пакует клиентские данные в PBO файл. Позже этот файл автоматически будет скачиваться при подключении клиента к серверу.

**Важно:** Порядок модулей в `loader.hpp` критичен для правильной загрузки.

#### Сборка серверного кода

Серверный код собирается в PBO файлы для развертывания на сервере:

1. RBuilder обрабатывает `host/init.sqf`
2. Компилирует все модули, загружаемые через `loadFile()`
3. Упаковывает код в PBO формат
4. Генерирует необходимые файлы конфигурации

### Команды RBuilder

RBuilder поддерживает несколько типов операций: `build`, `run` и `deploy`. Каждая операция имеет свои аргументы.

> [!NOTE]
> Список всех флагов можно посмотреть с помощью команды `rb -help` или `rb -h`.

#### Инициализация конфигурации

Перед началом работы необходимо инициализировать конфигурацию RBuilder:

```bash
rb -init
```

Эта команда создаст файл `config.yml` в директории RBuilder, если он еще не существует.

#### Общие опции приложения

Эти опции можно использовать с любой командой:

- `-init` - Инициализировать конфигурацию
- `-log FILE` - Включить логирование в файл
- `-verbose` - Включить подробное логирование
- `-sdk PATH` - Изменить путь к ReSDK (используется для компилятора библиотек ReNode)
- `-testapp` - Тестовый запуск rb (используется в ci/cd pipeline)

#### Команда build (сборка)

Команда `build` (также доступна как `b`, `compile`, `make`) используется для сборки/компиляции или подготовки кода для запуска:

```bash
# Базовая сборка
rb build

# Сборка с использованием симлинков
rb build -link
```

**Опции команды build:**
- `-link` или `-l` - Использовать исходники как симлинки (не требует пересборки кода из исходников, что ускоряет итерацию при разработке)

#### Команда run (запуск)

Команда `run` (также доступна как `r`, `start`, `exec`) используется для запуска приложения:

```bash
# Базовый запуск
rb run

# Запуск с определением макросов
rb run -def DEBUG
rb run -def RELEASE -def TEST_ALL

# Запуск с параметрами платформы
rb run -p param1 -p param2

# Запуск с файлом параметров (параметры запуска для Платформы)
rb run -pfile params.txt

# Запуск с автоматической перезагрузкой
rb run -autoreload

# Запуск с созданием новой базы данных
rb run -dbreload

# Запуск с показом содержимого RPT при выходе
rb run -rptshow
```

**Опции команды run:**
- `-dbreload` - Создать новую базу данных
- `-rptshow` или `-rpt` - Показать содержимое RPT при выходе из RBuilder
- `-autoreload` или `-ar` или `-r` - Перезагрузка при выполнении VM
- `-def` или `-f` или `-d MACRO_NAME` - Определить макропеременную (можно использовать несколько раз)
- `-p PARAM_NAME` - Определить параметры запуска платформы (можно использовать несколько раз)
- `-pfile FILE` - Определить файл параметров для запуска платформы

**Примеры использования макросов:**
```bash
# Запуск в режиме отладки
rb run -def DEBUG

# Запуск в релизном режиме
rb run -def RELEASE

# Запуск тестов в режиме отладки
rb run -def TEST_ALL -def DEBUG
```

### Деплой через RBuilder

Команда `deploy` (также доступна как `d`, `pack`) используется для развертывания приложения или бинарных файлов редактора.

#### Деплой редактора

```bash
# Деплой мода редактора (укажет путь к Arma 3, если не указан)
rb deploy -editor

# Деплой с указанием директории платформы
rb deploy -editor ARMA3_DIR

# Или используйте DEPLOY.bat в папке RBuilder
DEPLOY.bat
```

**Что делает:**
- Копирует файлы из `RBuilder/deploy/editor/` в `@EditorContent`
- Подготавливает необходимые DLL и ресурсы
- Создает структуру мода для Arma 3

**Где:** `Arma3/@EditorContent/`

#### Деплой клиентских модулей

> [!WARNING]
> Для сборки клиента кодовая база должна быть собрана (`rb build`) 

```bash
# Деплой клиентской сборки (release по умолчанию)
rb deploy -client

# Деплой клиентской сборки в режиме debug
rb deploy -client debug

# Деплой клиентской сборки в режиме release
rb deploy -client release
```

Клиентские модули автоматически включаются в файл миссии при сборке.

#### Деплой серверных модулей

```bash
# Деплой серверных модулей
rb deploy -server
```

Серверные модули упаковываются в PBO и размещаются на сервере.

#### Комбинированный деплой

```bash
# Деплой клиента и сервера одновременно
rb deploy -client release -server

# Деплой с указанием директории для бинарных файлов
rb deploy -client release -server -bin ./bin

# Деплой с указанием хранилища версий
rb deploy -client release -server -storage "C:\Versions"

# Деплой с пометкой как нестабильная версия
rb deploy -client release -server -unstable
```

**Опции команды deploy:**
- `-editor [PLATFORM_DIR]` - Развернуть бинарные файлы редактора (если PLATFORM_DIR не указан, используется текущая директория)
- `-client [release|debug]` - Создать клиентский бинарный файл (по умолчанию release)
- `-server` - Создать серверный бинарный файл
- `-unstable` - Пометить скомпилированный бинарный файл как нестабильный (промежуточная версия для тестовых запусков сервера)
- `-bin DIR` - Временная папка для бинарных файлов (по умолчанию из `config.yml`: `bin_dir`)
- `-storage` или `-s [DIR]` - Директория хранилища версий (если DIR не указан, используется текущая директория)

### Конфигурация путей

RBuilder использует пути из `config.yml`:

```yaml
pathes:
  sources: ../Src              # Исходный код
  deploy_dir: ./deploy         # Директория деплоя
  bin_dir: ./bin              # Временные файлы сборки
```

### Включение/исключение файлов

В `config.yml` можно настроить, какие файлы включать/исключать (перечисление через точку с запятой):

```yaml
build:
  include: Inventory\inventory.hpp;LightEngine\LightEngine.hpp
  exclude: Editor;Scripts;.vscode
```

## RVEngine (минимальная информация)

**Важно:** RVEngine - это внешний компонент с собственной документацией и системой сборки.

### Основная информация

- RVEngine - это C++ расширение для Платформы, основанное на Intercept
- Имеет собственную систему сборки на основе CMake
- Документация находится в `Documentation/RVEngine/`
- Разработчики проекта не поддерживают RVEngine напрямую
- RVEngine стоит использовать в действительно критичных случаях, когда не удается выжать ещё больше производительности из скриптового кода (прим. AI, pathfinding)

### Для работы с RVEngine

См. документацию в `Documentation/RVEngine/BUILD_GUIDE.md` и `Documentation/RVEngine/README.md`.

## Деплой

### Структура деплоя

```
Arma3/
├── @EditorContent/          # Мод редактора
│   ├── *.dll               # Библиотеки редактора
│   └── ...
└── missions/
    └── ReSDK_A3.vr/        # Миссия с кодом
        ├── CLIENT          # Клиентский код
        ├── *.pbo           # Серверные модули
        └── ...
```

### Деплой редактора

1. Запустите `RBuilder/DEPLOY.bat` или `rb deploy -editor`
2. Укажите путь к Arma 3, если запрошено
3. Подключите мод `@EditorContent` в лаунчере Arma 3
4. Запустите Arma 3 с выключенным BattlEye

**Важно:** Первый раз RBuilder запросит путь к Arma 3 и сохранит его в `platform_path.cache`.

### Деплой на сервер

1. Соберите проект в режиме RELEASE
2. Скопируйте PBO файлы на сервер
3. Разместите их в соответствующей директории сервера (хранилище версий)
4. Запустите сервер с указаннием версии, либо загрузите её через web-интерфейс менеджера версий

### Проверка корректности деплоя

#### Проверка редактора

1. Запустите Arma 3 с модом `@EditorContent`
2. Откройте редактор
3. Загрузите миссию `ReSDK_A3.vr`
4. Проверьте логи на ошибки загрузки

#### Проверка клиентской сборки

1. Проверьте наличие файла `CLIENT` в миссии
2. Подключитесь к серверу
3. Проверьте логи клиента на ошибки загрузки

#### Проверка серверной сборки

1. Проверьте наличие всех необходимых PBO файлов
2. Запустите сервер
3. Проверьте логи сервера на ошибки загрузки

## Типичные проблемы

### Ошибки компиляции

**Проблема:** Ошибки при сборке модулей

**Решение:**
- Проверьте синтаксис кода
- Убедитесь, что все зависимости загружены
- Проверьте логи RBuilder на детали ошибок

### Отсутствующие файлы при деплое

**Проблема:** Файлы не копируются в хралище версий

**Решение:**
- Проверьте пути в `config.yml`
- Убедитесь, что файлы существуют в директории деплоя
- Проверьте права доступа к файлам

### Версии не совпадают

**Проблема:** Клиент и сервер имеют разные версии

**Решение:**
- Убедитесь, что файл `VERSION` одинаковый
- Пересоберите проект
- Очистите кэш сборки

## Что дальше?

- ➡️ [Версионирование](07_VERSIONING.md) - управление версиями при сборке
- ➡️ [Отладка](05_DEBUGGING.md) - отладка собранного проекта
- ➡️ [Решение проблем](10_TROUBLESHOOTING.md) - дополнительные решения проблем

